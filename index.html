<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Attendance Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--primary);
        }

        .skeleton-loader {
            animation: pulse 1.5s infinite;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chart-container {
            height: 300px;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="py-4">
    <div class="container">
        <div class="glass-card p-4 mb-4 animate__animated animate__fadeIn">
            <h1 class="text-center mb-4 fw-bold text-primary">
                <i class="bi bi-calendar-check"></i> Payroll Attendance System
            </h1>

            <div class="row g-3 mb-4">
                <div class="col-lg-5">
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white">
                            <i class="bi bi-person"></i>
                        </span>
                        <input type="text" id="employeeName" class="form-control form-control-lg" 
                               placeholder="Enter employee name" autocomplete="off">
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white">
                            <i class="bi bi-calendar"></i>
                        </span>
                        <select id="month" class="form-select form-select-lg">
                            <option value="1">January (26 Dec - 25 Jan)</option>
                            <option value="2">February (26 Jan - 25 Feb)</option>
                            <option value="3">March (26 Feb - 25 Mar)</option>
                            <option value="4">April (26 Mar - 25 Apr)</option>
                            <option value="5">May (26 Apr - 25 May)</option>
                            <option value="6">June (26 May - 25 Jun)</option>
                            <option value="7">July (26 Jun - 25 Jul)</option>
                            <option value="8">August (26 Jul - 25 Aug)</option>
                            <option value="9">September (26 Aug - 25 Sep)</option>
                            <option value="10">October (26 Sep - 25 Oct)</option>
                            <option value="11">November (26 Oct - 25 Nov)</option>
                            <option value="12">December (26 Nov - 25 Dec)</option>
                        </select>
                    </div>
                </div>

                <div class="col-lg-2">
                    <button class="btn btn-primary btn-lg w-100 h-100" 
                            onclick="fetchAttendance()"
                            id="generateBtn">
                        <i class="bi bi-file-earmark-text"></i> Generate Report
                    </button>
                </div>
            </div>

            <div id="cycleInfo" class="text-center mb-4"></div>
        </div>

        <div id="output" class="glass-card p-4 animate__animated animate__fadeInUp"></div>
    </div>

    <!-- Chart Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        const SHEET_ID = "1xydLswJHJPS6Vry7P7XcjUMdTRJK1vQ-VatN4B4chLI";
        const API_KEY = "AIzaSyBIAZIlEL2OqSP4SGvUjcjZwL9p7aPVWuA";
        const MONTHLY_SALARY = 5500;
        const WORKING_DAYS = 26;
        let attendanceChart = null;

        async function fetchAttendance() {
            const employeeName = document.getElementById("employeeName").value.trim();
            const month = document.getElementById("month").value;
            const outputDiv = document.getElementById("output");
            const btn = document.getElementById("generateBtn");
            
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;
            outputDiv.innerHTML = createSkeletonLoader();
            
            try {
                const { sheets, cycleDates } = await getCycleSheets(month);
                if (!sheets.length) return showError("No attendance records found for this cycle", outputDiv);
                
                const { presentDays, absences, deductions } = await processAttendanceData(sheets, employeeName);
                if (!presentDays.length) return showError("No records found for this employee", outputDiv);


                // Add these functions after the existing helper functions and before displayDashboard

function handleError(error, container) {
    console.error('Error:', error);
    let errorMessage = 'An unexpected error occurred. Please try again.';
    
    if (error.message === 'API_ERROR') {
        errorMessage = 'Failed to fetch data from Google Sheets. Please check your connection and try again.';
    }
    
    showError(errorMessage, container);
}

function showError(message, container) {
    container.innerHTML = `
        <div class="alert alert-danger animate__animated animate__shakeX" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            ${message}
        </div>
    `;
}

function checkLateArrival(checkInTime) {
    if (!checkInTime) return false;
    const [hours, minutes] = checkInTime.split(':').map(Number);
    return hours > 9 || (hours === 9 && minutes > 30);
}

function checkEarlyDeparture(checkOutTime) {
    if (!checkOutTime) return 'full-day';
    const [hours, minutes] = checkOutTime.split(':').map(Number);
    if (hours < 16) return 'full-day';
    if (hours < 17 || (hours === 17 && minutes < 30)) return 'half-day';
    return false;
}

function updateCycleInfo(cycleDates) {
    const cycleInfo = document.getElementById('cycleInfo');
    cycleInfo.innerHTML = `
        <div class="text-muted">
            <i class="bi bi-info-circle"></i>
            Attendance cycle: ${cycleDates[0]} to ${cycleDates[cycleDates.length - 1]}
        </div>
    `;
}
                
                displayDashboard(presentDays, absences, deductions, cycleDates, outputDiv);
                updateCycleInfo(cycleDates);
            } catch (error) {
                handleError(error, outputDiv);
            } finally {
                btn.innerHTML = `<i class="bi bi-file-earmark-text"></i> Generate Report`;
            }
        }

        // Helper Functions
        function createSkeletonLoader() {
            return `
                <div class="skeleton-loader p-4">
                    <div class="skeleton-line mb-3" style="height: 35px; width: 60%"></div>
                    <div class="skeleton-line mb-4" style="height: 100px"></div>
                    <div class="row g-4">
                        ${Array(3).fill().map(() => `
                            <div class="col-md-4">
                                <div class="skeleton-line" style="height: 150px"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function getCycleSheets(month) {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`);
            if (!response.ok) throw new Error('API_ERROR');
            
            const data = await response.json();
            const allSheets = data.sheets.map(sheet => sheet.properties.title);
            const cycleDates = generateCycleDates(month);
            
            return {
                sheets: allSheets.filter(sheet => cycleDates.includes(sheet)),
                cycleDates
            };
        }

        function generateCycleDates(targetMonth) {
            const dates = [];
            const prevMonth = targetMonth > 1 ? targetMonth - 1 : 12;
            
            // Previous month days (26-31)
            for (let day = 26; day <= 31; day++) {
                dates.push(`${day}/${String(prevMonth).padStart(2, '0')}`);
            }
            
            // Current month days (1-25)
            for (let day = 1; day <= 25; day++) {
                dates.push(`${String(day).padStart(2, '0')}/${String(targetMonth).padStart(2, '0')}`);
            }
            
            return dates;
        }

        async function processAttendanceData(sheetNames, employeeName) {
            let presentDays = [];
            let absences = [];
            let deductions = [];
            
            // Parallel processing of sheets
            await Promise.all(sheetNames.map(async (sheet) => {
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheet)}?key=${API_KEY}`
                    );
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    if (!data.values) return;

                    const employeeRow = data.values.find(row => row[3]?.trim() === employeeName);
                    if (!employeeRow) {
                        absences.push(sheet);
                        return;
                    }

                    const record = processAttendanceRecord(sheet, employeeRow);
                    presentDays.push(record);
                    
                    if (record.lateArrival || record.earlyDeparture) {
                        deductions.push({
                            date: record.date,
                            type: record.lateArrival ? 'Late Arrival' : 'Early Departure',
                            value: record.deductionValue,
                            details: record.details
                        });
                    }
                } catch (error) {
                    console.error(`Error processing ${sheet}:`, error);
                }
            }));

            return { presentDays, absences, deductions };
        }

        function processAttendanceRecord(sheetName, row) {
            const [day, month] = sheetName.split('/');
            const record = {
                date: `${day.padStart(2, '0')}/${month.padStart(2, '0')}`,
                checkIn: row[14]?.trim() || "N/A",
                checkOut: row[15]?.trim() || "N/A",
                lateArrival: checkLateArrival(row[14]),
                earlyDeparture: checkEarlyDeparture(row[15]),
                deductionValue: 0,
                details: ''
            };

            // Calculate deductions
            if (record.lateArrival) {
                record.deductionValue += 0.5;
                record.details = `Late arrival (${record.checkIn})`;
            }
            if (record.earlyDeparture) {
                record.deductionValue += record.earlyDeparture === 'full-day' ? 1 : 0.5;
                record.details += record.details ? ', ' : '';
                record.details += `Early departure (${record.checkOut})`;
            }

            return record;
        }

        // ... (Rest of the helper functions remain similar with UI enhancements)

        function displayDashboard(presentDays, absences, deductions, cycleDates, container) {
            const dailySalary = MONTHLY_SALARY / WORKING_DAYS;
            const totalDeductions = deductions.reduce((sum, d) => sum + d.value, 0);
            const netSalary = (presentDays.length - totalDeductions) * dailySalary;

            container.innerHTML = `
                <div class="row g-4 mb-4">
                    <!-- Summary Cards -->
                    <div class="col-md-4">
                        <div class="glass-card p-3 text-center h-100">
                            <h5 class="text-primary">Working Days</h5>
                            <div class="display-3 fw-bold">${presentDays.length}</div>
                            <small class="text-muted">out of ${cycleDates.length}</small>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="glass-card p-3 text-center h-100">
                            <h5 class="text-danger">Total Deductions</h5>
                            <div class="display-3 fw-bold">${totalDeductions}</div>
                            <small class="text-muted">days</small>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="glass-card p-3 text-center h-100">
                            <h5 class="text-success">Expected Salary</h5>
                            <div class="display-3 fw-bold">${netSalary.toFixed(2)}</div>
                            <small class="text-muted">EGP</small>
                        </div>
                    </div>
                </div>

                <!-- Detailed Sections -->
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="glass-card p-4 h-100">
                            <h4 class="mb-4"><i class="bi bi-bar-chart"></i> Attendance Overview</h4>
                            <div class="chart-container">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="glass-card p-4 h-100">
                            <h4 class="mb-4"><i class="bi bi-exclamation-triangle"></i> Deductions</h4>
                            ${deductions.length ? deductions.map(d => `
                                <div class="timeline-item animate__animated animate__fadeInRight">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="mb-1">${d.date}</h6>
                                            <small class="text-muted">${d.type}</small>
                                        </div>
                                        <span class="status-badge bg-danger">
                                            -${d.value} day${d.value > 1 ? 's' : ''}
                                        </span>
                                    </div>
                                    <small class="text-muted d-block mt-1">${d.details}</small>
                                </div>
                            `).join('') : `<div class="text-center text-muted">No deductions found</div>`}
                        </div>
                    </div>
                </div>
            `;

            // Initialize Chart
            initAttendanceChart(presentDays, absences, deductions);
        }

        function initAttendanceChart(present, absent, deductions) {
            if (attendanceChart) attendanceChart.destroy();
            
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            attendanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present Days', 'Absences', 'Deductions'],
                    datasets: [{
                        data: [present.length, absent.length, deductions.length],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { enabled: true }
                    },
                    animation: { duration: 1000 }
                }
            });
        }

        // ... (Error handling and other helper functions)

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</body>
</html>
