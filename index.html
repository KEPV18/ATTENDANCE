<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --background: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--primary-color);
            padding: 2rem 0;
        }

        .container {
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 0 auto;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .result-card {
            border-left: 4px solid;
            padding: 1.25rem;
            margin: 1rem 0;
        }

        .deduction-item {
            border-left: 3px solid var(--danger-color);
            padding-left: 1rem;
            margin: 0.5rem 0;
        }

        .salary-box {
            background: #e9f5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .accordion-button:not(.collapsed) {
            background-color: rgba(52, 152, 219, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Employee Attendance Tracker</h1>
        
        <div class="input-section">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="employeeName" class="form-control form-control-lg" placeholder="Enter employee name">
                </div>
                <div class="col-md-4">
                    <select id="month" class="form-select form-select-lg">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-lg w-100" onclick="fetchAttendance()">Generate Report</button>
                </div>
            </div>
        </div>

        <div id="output"></div>
    </div>

    <script>
        const SHEET_ID = "1xydLswJHJPS6Vry7P7XcjUMdTRJK1vQ-VatN4B4chLI";
        const API_KEY = "AIzaSyBIAZIlEL2OqSP4SGvUjcjZwL9p7aPVWuA";
        const MONTHLY_SALARY = 5500;
        const WORKING_DAYS = 26;

        async function fetchAttendance() {
            const employeeName = document.getElementById("employeeName").value.trim();
            const month = document.getElementById("month").value;
            const outputDiv = document.getElementById("output");
            
            outputDiv.innerHTML = createLoading();
            if (!validateInput(employeeName)) return;

            try {
                const sheets = await getMonthSheets(month);
                if (!sheets.length) return showError("No data found for selected month", outputDiv);
                
                const { presentDays, allDays } = await processSheets(sheets, employeeName);
                if (!presentDays.length) return showError("No records found for this employee", outputDiv);
                
                displayReport(presentDays, allDays, month, outputDiv);
            } catch (error) {
                handleError(error, outputDiv);
            }
        }

        // Helper functions
        function createLoading() {
            return `<div class="d-flex align-items-center text-primary">
                <div class="spinner-border me-2"></div>
                Analyzing attendance data...
            </div>`;
        }

        function validateInput(name) {
            if (!name) {
                showError("Please enter employee name", document.getElementById("output"));
                return false;
            }
            return true;
        }

        async function getMonthSheets(month) {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`);
            if (!response.ok) throw new Error('API_ERROR');
            
            const data = await response.json();
            return data.sheets
                .filter(sheet => sheet.properties.title.split('/')[1] === month)
                .map(sheet => sheet.properties.title);
        }

        async function processSheets(sheetNames, employeeName) {
            let presentDays = [];
            const allDays = [];
            
            for (const sheetName of sheetNames) {
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`
                    );
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    if (!data.values) continue;

                    const day = sheetName.split('/')[0];
                    allDays.push(parseInt(day));
                    
                    const employeeRow = data.values.find(row => row[3] === employeeName);
                    if (!employeeRow) continue;

                    presentDays.push(processAttendanceRow(day, employeeRow));
                } catch (error) {
                    console.error('Sheet processing error:', error);
                }
            }
            return { presentDays, allDays };
        }

        function processAttendanceRow(day, row) {
            return {
                day,
                status: row[14] || "0",
                time: row[15]?.trim() || "",
                deduction: row[17]?.trim() || "",
                isLate: checkLateTime(row[15])
            };
        }

        function checkLateTime(timeStr) {
            if (!timeStr) return false;
            const [timePart, period] = timeStr.split(' ');
            let [hours, minutes] = timePart.split(':').map(Number);
            
            if (period?.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (period?.toUpperCase() === 'AM' && hours === 12) hours = 0;
            
            return hours > 8 || (hours === 8 && minutes > 5);
        }

        function displayReport(presentDays, allDays, month, container) {
            const dailySalary = MONTHLY_SALARY / WORKING_DAYS;
            const deductions = calculateDeductions(presentDays);
            const absentDays = calculateAbsences(allDays, presentDays.map(p => p.day));
            
            container.innerHTML = `
                <div class="row g-4">
                    <!-- Summary Cards -->
                    <div class="col-md-4">
                        <div class="result-card border-success">
                            <h5>Present Days</h5>
                            <div class="display-4">${presentDays.length}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="result-card border-danger">
                            <h5>Absent Days</h5>
                            <div class="display-4">${absentDays.length}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="result-card border-primary">
                            <h5>Deductions</h5>
                            <div class="display-4">${deductions.total}</div>
                        </div>
                    </div>

                    <!-- Salary Calculation -->
                    <div class="col-12">
                        <div class="salary-box">
                            <div class="row">
                                <div class="col-md-4">
                                    <h5>Daily Salary</h5>
                                    <p>$${dailySalary.toFixed(2)}</p>
                                </div>
                                <div class="col-md-4">
                                    <h5>Net Working Days</h5>
                                    <p>${presentDays.length - deductions.total}</p>
                                </div>
                                <div class="col-md-4">
                                    <h5>Expected Salary</h5>
                                    <p class="text-success">$${(dailySalary * (presentDays.length - deductions.total)).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Sections -->
                    <div class="col-12">
                        <div class="accordion" id="reportAccordion">
                            ${createAccordionSection('present', 'Present Days', presentDays)}
                            ${createAccordionSection('absent', 'Absent Days', absentDays)}
                            ${createAccordionSection('deductions', 'Deductions', deductions.list)}
                        </div>
                    </div>
                </div>
            `;
        }

        function createAccordionSection(type, title, items) {
            return `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${type !== 'present' ? 'collapsed' : ''}" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#${type}Section">
                            ${title} (${items.length})
                        </button>
                    </h2>
                    <div id="${type}Section" 
                         class="accordion-collapse collapse ${type === 'present' ? 'show' : ''}" 
                         data-bs-parent="#reportAccordion">
                        <div class="accordion-body">
                          ${items.map(item => type === 'deductions' ? `
    <div class="deduction-item">
        <strong>${item.day}:</strong> ${item.details}
        <span class="badge bg-danger">${item.value} day</span>
    </div>
` : `
    <div class="d-flex justify-content-between py-2 border-bottom">
        <span>${item.day || item}</span>
        ${item.isLate ? `<span class="text-danger">Late (${item.time})</span>` : ''}
    </div>
`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateDeductions(presentDays) {
            let total = 0;
            const list = [];
            
            presentDays.forEach(day => {
                if (day.isLate) {
                    total += 0.5;
                    list.push({
                        day: day.day,
                        details: `Late arrival (${day.time})`,
                        value: 0.5
                    });
                }
                if (day.deduction) {
                    total += 1;
                    list.push({
                        day: day.day,
                        details: day.deduction,
                        value: 1
                    });
                }
            });
            
            return { total, list };
        }

        function calculateAbsences(allDays, presentDays) {
            return Array.from({length: 31}, (_, i) => i + 1)
                .filter(day => 
                    allDays.includes(day) && 
                    !presentDays.includes(day.toString())
                );
        }

        function showError(message, container) {
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        function handleError(error, container) {
            console.error(error);
            const message = error.message === 'API_ERROR' 
                ? 'API Error - Check credentials and sheet sharing settings'
                : 'Connection Error - Please check internet connection';
            showError(message, container);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
